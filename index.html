<!DOCTYPE html>
<html lang="pt">
<head>
  <title>Sistema de Controle de Ponto</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.js"></script>
  <style>
    body {
      font-family:'Courier New', Courier, monospace
    }

    h1 {
      text-align: center;
    }

    #punch-in-out {
      text-align: center;
    }

    #punch-in-out input {
      margin-top: 10px;
    }

    #report {
      margin-top: 20px;
      text-align: center;
    }

    #report table {
      margin: 0 auto;
      border-collapse: collapse;
      font-size: small;

    }

    #report table th,
    #report table td {
      border: 1px solid #000;
    }

    #employee-id {
      padding: 10px;
      border-radius: 5px;
    }

    .checkmark {
      display: inline-block;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      border: 2px solid #000;
      background-color: #2ecc71;
      animation: checkmark 3s linear;
    }

    @keyframes checkmark {
      0% {
        transform: scale(0);
        opacity: 0;
      }
      50% {
        transform: scale(1.2);
        opacity: 1;
      }
      100% {
        transform: scale(1);
        opacity: 0;
      }
    }

    #employee-report {
      text-align: center;
      font-size: 18px;
    }

    #reset-button {
      margin-top: 10px;
    }

    .checkmark-wrapper {
      position: fixed;
      top: 75%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 9999;
      width: 10cm;
      height: 10cm;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      overflow: hidden;
    }

    .checkmark-wrapper img {
      max-width: 30%;
      max-height: 70%;
    }

    .checkmark-wrapper span {
      font-size: 20px;
      margin-top: 10px;
    }

    .day-of-week {
      color: rgb(8, 8, 8);
    }

    button {
  padding: 10px 20px;
  background-color: #0984e3;
  color: #ffffff;
  border: none;
  border-radius: 4px;
  font-family: 'Arial', sans-serif;
  font-size: 14px;
  cursor: pointer;
  margin-right: 10px;
}

#reset-button {
  background-color: #d63031;
}

#employee-select {
        width: 230px;
        padding: 10px;
        font-size: 16px;
        border: 1px solid #ccc;
        border-radius: 3px;
    }

    #employee-report {
        padding: 10px;
    }

    #report {
        background-color: #f5f5f5;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.1);
    }

  </style>
</head>
<body>
  <h1>Ponto</h1>

  <div id="punch-in-out">
    <label for="employee-id">Código de Matrícula:</label><br>
    <input type="text" id="employee-id" autofocus onkeydown="registerPunch(event)">
  </div>

  <div id="report">
    <h2>Folha de Ponto</h2>
    <select id="employee-select" onchange="generateReport()">
      <option value="">Selecione um colaborador</option>
      <option value="11118">Welton Alves Esteves</option>
      <option value="002">Beatriz Fernanda Veratti</option>
    </select><br><br>
    <div id="employee-report"></div>
    <button onclick="generatePDF()">Gerar PDF</button>
    <button id="reset-button" onclick="resetPunches()">Resetar</button>
  </div>

  <!-- Container da imagem do checkmark -->
  <div id="checkmark-wrapper" class="checkmark-wrapper" style="display: none;">
    <img id="checkmark-image" src="https://imagepng.org/wp-content/uploads/2019/12/check-icone-3.png" alt="Checkmark">
    <span id="checkmark-text"></span>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/locale/pt-br.js"></script>
  <script>
    function buscarColaborador(codigo) {
      const colaboradores = {
        '11118': {
          nome: 'Welton A Esteves',
          cpf: '401.260.068-06',
          horarios: {
            entradaManha: { inicio: '07:00', fim: '09:30' },
            saidaManha: { inicio: '11:00', fim: '12:20' },
            entradaTarde: { inicio: '13:00', fim: '15:00' },
            saidaTarde: { inicio: '17:00', fim: '20:30' },
          },
        },
        '002': {
          nome: 'Beatriz Fernanda Veratti',
          cpf: '222.222.222-22',
          horarios: {
            entradaManha: { inicio: '07:00', fim: '09:30' },
            saidaManha: { inicio: '11:00', fim: '12:20' },
            entradaTarde: { inicio: '13:00', fim: '15:00' },
            saidaTarde: { inicio: '17:00', fim: '19:00' },
          },
        },
        // Adicione outros colaboradores aqui...
      };

      return colaboradores[codigo];
    }

    var employees = [
      { id: "11118", name: "Welton Alfa Esteves", jornada: 8.48 },
      { id: "002", name: "Beatriz Fernanda Veratti", jornada: 8.48 },
    ];

    var punches = [];

    if (typeof Storage !== "undefined") {
      var punchesData = localStorage.getItem("punches");
      if (punchesData) {
        punches = JSON.parse(punchesData);
      }
    } else {
      alert("Seu navegador não suporta o recurso de Local Storage. Por favor, atualize-o.");
    }

   function registerPunch(event) {
  if (event.keyCode === 13) {
    var employeeId = document.getElementById("employee-id").value;
    var employee = getEmployeeById(employeeId);

    if (employee) {
      var date = new Date().toLocaleDateString();
      var time = new Date().toLocaleTimeString();

      var punchType = getPunchType(time, employeeId);
      var lastPunch = getLastPunch(employeeId);

      if (lastPunch && lastPunch.date === date) {
        // Atualiza o registro existente caso seja do mesmo dia
        if (punchType === "entrada_manha" && lastPunch.punchType === "entrada_manha") {
          lastPunch.time = time;
        } else if (punchType === "saida_manha" && lastPunch.punchType === "saida_manha") {
          lastPunch.time = time;
        } else if (punchType === "entrada_tarde" && lastPunch.punchType === "entrada_tarde") {
          lastPunch.time = time;
        } else if (punchType === "saida_tarde" && lastPunch.punchType === "saida_tarde") {
          lastPunch.time = time;
        } else if (punchType === "extra" && lastPunch.punchType === "extra") {
          lastPunch.time = time;
        } else if (punchType === "horas_trabalhadas" && lastPunch.punchType === "horas_trabalhadas") {
          lastPunch.time = time;
        } else {
          // Adiciona um novo registro na célula do lado
          punches.splice(punches.indexOf(lastPunch) + 1, 0, {
            employeeId: employeeId,
            employeeName: employee.name,
            date: date,
            time: time,
            punchType: punchType
          });
        }
      } else {
        // Adiciona um novo registro
        punches.push({
          employeeId: employeeId,
          employeeName: employee.name,
          date: date,
          time: time,
          punchType: punchType
        });
      }

      localStorage.setItem("punches", JSON.stringify(punches));
      document.getElementById("employee-id").value = "";

      showCheckmark(employee.name);
      generateReport();
    } else {
      alert("Colaborador não encontrado. Verifique o código de matrícula digitado.");
    }
  }
}
function registerPunch(event) {
  if (event.keyCode === 13) {
    var employeeId = document.getElementById("employee-id").value;
    var employee = getEmployeeById(employeeId);

    if (employee) {
      var date = new Date().toLocaleDateString();
      var time = new Date().toLocaleTimeString();

      var punchType = getPunchType(time, employeeId);
      var lastPunch = getLastPunch(employeeId);

      if (lastPunch && lastPunch.date === date) {
        // Atualiza o registro existente caso seja do mesmo dia
        if (punchType === "entrada_manha" && lastPunch.punchType === "entrada_manha") {
          lastPunch.time = time;
        } else if (punchType === "saida_manha" && lastPunch.punchType === "saida_manha") {
          lastPunch.time = time;
        } else if (punchType === "entrada_tarde" && lastPunch.punchType === "entrada_tarde") {
          lastPunch.time = time;
        } else if (punchType === "saida_tarde" && lastPunch.punchType === "saida_tarde") {
          lastPunch.time = time;
        } else if (punchType === "extra" && lastPunch.punchType === "extra") {
          lastPunch.time = time;
        } else if (punchType === "horas_trabalhadas" && lastPunch.punchType === "horas_trabalhadas") {
          lastPunch.time = time;
        } else {
          // Adiciona um novo registro na célula do lado
          punches.splice(punches.indexOf(lastPunch) + 1, 0, {
            employeeId: employeeId,
            employeeName: employee.name,
            date: date,
            time: time,
            punchType: punchType
          });
        }
      } else {
        // Adiciona um novo registro
        punches.push({
          employeeId: employeeId,
          employeeName: employee.name,
          date: date,
          time: time,
          punchType: punchType
        });
      }

      localStorage.setItem("punches", JSON.stringify(punches));
      document.getElementById("employee-id").value = "";

      showCheckmark(employee.name);
      generateReport();
    } else {
      alert("Colaborador não encontrado. Verifique o código de matrícula digitado.");
    }
  }
}


    function generateReport() {
  var employeeSelect = document.getElementById("employee-select");
  var selectedEmployeeId = employeeSelect.value;
  var employeeReport = document.getElementById("employee-report");
  employeeReport.innerHTML = "";

  if (selectedEmployeeId) {
    var punchesFiltered = punches.filter(function (punch) {
      return punch.employeeId === selectedEmployeeId;
    });

    var table = document.createElement("table");
    table.classList.add("report-table");

    var headerRow = document.createElement("tr");
    var headers = ["Data", "Dia da Semana", "Entrada Manhã", "Saída Manhã", "Entrada Tarde", "Saída Tarde", "Hora Extra", "Horas Trabalhadas"];

    headers.forEach(function (headerText) {
      var headerCell = document.createElement("th");
      headerCell.textContent = headerText;
      headerRow.appendChild(headerCell);
    });

    table.appendChild(headerRow);

    var punchTypes = ["entrada_manha", "saida_manha", "entrada_tarde", "saida_tarde", "extra", "horas_trabalhadas"];

    var firstPunchDate = punchesFiltered.length > 0 ? punchesFiltered[0].date : null;
    var lastPunchDate = punchesFiltered.length > 0 ? punchesFiltered[punchesFiltered.length - 1].date : null;

    if (firstPunchDate && lastPunchDate) {
      var currentDate = moment(firstPunchDate, "DD/MM/YYYY");
      var lastPunchIndex = 0;

      while (currentDate.isSameOrBefore(moment(lastPunchDate, "DD/MM/YYYY"))) {
        var row = document.createElement("tr");

        var dateCell = document.createElement("td");
        dateCell.textContent = currentDate.format("DD/MM/YYYY");
        row.appendChild(dateCell);

        var dayOfWeekCell = document.createElement("td");
        dayOfWeekCell.textContent = currentDate.format("dddd");
        row.appendChild(dayOfWeekCell);

        punchTypes.forEach(function (punchType) {
          var timeCell = document.createElement("td");

          if (lastPunchIndex < punchesFiltered.length) {
            var punch = punchesFiltered[lastPunchIndex];

            if (punch.date === currentDate.format("DD/MM/YYYY") && punch.punchType === punchType) {
              timeCell.textContent = punch.time;
              lastPunchIndex++;
            } else {
              timeCell.textContent = "-";
            }
          } else {
            timeCell.textContent = "-";
          }

          row.appendChild(timeCell);
        });

        table.appendChild(row);

        currentDate.add(1, "day");
      }
    }

    employeeReport.appendChild(table);
  }
}

    function getEmployeeById(employeeId) {
      return employees.find(function (employee) {
        return employee.id === employeeId;
      });
    }

    function getPunchType(time, employeeId) {
  var employee = buscarColaborador(employeeId);
  var horarios = employee.horarios;

  if (time >= horarios.entradaManha.inicio && time <= horarios.entradaManha.fim) {
    return "entrada_manha";
  } else if (time >= horarios.saidaManha.inicio && time <= horarios.saidaManha.fim) {
    return "saida_manha";
  } else if (time >= horarios.entradaTarde.inicio && time <= horarios.entradaTarde.fim) {
    return "entrada_tarde";
  } else if (time >= horarios.saidaTarde.inicio && time <= horarios.saidaTarde.fim) {
    return "saida_tarde";
  } else if (time > horarios.saidaTarde.fim) {
    return "extra";
  } else {
    return "horas_trabalhadas";
  }
}

function buscarColaborador(codigo) {
  const colaboradores = {
    '11118': {
      nome: 'Welton A Esteves',
      cpf: '111.111.111-11',
      horarios: {
        entradaManha: { inicio: '07:34', fim: '09:35' },
        saidaManha: { inicio: '11:36', fim: '12:45' },
        entradaTarde: { inicio: '13:00', fim: '15:30' },
        saidaTarde: { inicio: '21:00', fim: '22:30' },
      },
    },
    '002': {
      nome: 'Jessica Freitas',
      cpf: '222.222.222-22',
      horarios: {
        entradaManha: { inicio: '08:00', fim: '08:30' },
        saidaManha: { inicio: '12:00', fim: '12:30' },
        entradaTarde: { inicio: '13:00', fim: '13:30' },
        saidaTarde: { inicio: '17:30', fim: '18:00' },
      },
    },
    // Adicione outros colaboradores aqui...
  };

  return colaboradores[codigo];
}

var employees = [
  { id: "11118", name: "Welton Alfa Esteves", jornada: 8.48 },
  { id: "002", name: "Jessica Freitas", jornada: 8.48 },
];

var punches = [];

if (typeof Storage !== "undefined") {
  var punchesData = localStorage.getItem("punches");
  if (punchesData) {
    punches = JSON.parse(punchesData);
  }
} else {
  alert("Seu navegador não suporta o recurso de Local Storage. Por favor, atualize-o.");
}


    function getLastPunch(employeeId) {
      var punchesFiltered = punches.filter(function (punch) {
        return punch.employeeId === employeeId;
      });

      if (punchesFiltered.length > 0) {
        return punchesFiltered[punchesFiltered.length - 1];
      } else {
        return null;
      }
    }

    function showCheckmark(employeeName) {
      var checkmarkWrapper = document.getElementById("checkmark-wrapper");
      var checkmarkImage = document.getElementById("checkmark-image");
      var checkmarkText = document.getElementById("checkmark-text");

      checkmarkText.innerText = employeeName;
      checkmarkWrapper.style.display = "flex";

      setTimeout(function () {
        checkmarkWrapper.style.display = "none";
      }, 3000);
    }

    function generatePDF() {
      var employeeSelect = document.getElementById("employee-select");
      var selectedEmployeeId = employeeSelect.value;

      if (!selectedEmployeeId) {
        var allEmployeesData = [];

        employees.forEach(function (employee) {
          var punchesFiltered = punches.filter(function (punch) {
            return punch.employeeId === employee.id;
          });

          var tableData = [];
          punchesFiltered.forEach(function (punch) {
            tableData.push([
              punch.date,
              punch.punchType === "entrada_manha" ? punch.time : "-",
              punch.punchType === "saida_manha" ? punch.time : "-",
              punch.punchType === "entrada_tarde" ? punch.time : "-",
              punch.punchType === "saida_tarde" ? punch.time : "-",
              punch.punchType === "extra" ? punch.time : "-",
              punch.punchType === "horas_trabalhadas" ? punch.time : "-"
            ]);
          });

          allEmployeesData.push({
            name: employee.name,
            tableData: tableData
          });
        });

        var opt = {
          margin: [0.5, 0.5, 0.5, 0.5],
          filename: "folha_ponto.pdf",
          image: { type: "jpeg", quality: 0.98 },
          html2canvas: { scale: 2 },
          jsPDF: { unit: "in", format: "letter", orientation: "portrait" },
          pagebreak: { avoid: ".report-table tr:nth-child(odd)" },
          pagebreak: { before: ".report-table" },
          pagebreak: { after: ".report-table" },
          pagebreak: { avoid: ".report-table tr" }
        };

        var worker = html2pdf().set(opt).from(document.querySelector("#report")).save();
      } else {
        var punchesFiltered = punches.filter(function (punch) {
          return punch.employeeId === selectedEmployeeId;
        });

        var tableData = [];
        punchesFiltered.forEach(function (punch) {
          tableData.push([
            punch.date,
            punch.punchType === "entrada_manha" ? punch.time : "-",
            punch.punchType === "saida_manha" ? punch.time : "-",
            punch.punchType === "entrada_tarde" ? punch.time : "-",
            punch.punchType === "saida_tarde" ? punch.time : "-",
            punch.punchType === "extra" ? punch.time : "-",
            punch.punchType === "horas_trabalhadas" ? punch.time : "-"
          ]);
        });

        var doc = new jsPDF();

        doc.setFontSize(16);
        doc.text("Folha de Ponto", 14, 10);
        doc.setFontSize(12);
        doc.text("Colaborador: " + getEmployeeById(selectedEmployeeId).name, 14, 20);
        doc.autoTable({
          startY: 30,
          head: [["Data", "Entrada Manhã", "Saída Manhã", "Entrada Tarde", "Saída Tarde", "Hora Extra", "Horas Trabalhadas"]],
          body: tableData,
          styles: { fontSize: 10 },
        });

        doc.save("folha_ponto.pdf");
      }
    }

    function resetPunches() {
      punches = [];
      localStorage.removeItem("punches");
      generateReport();
    }

    generateReport();

    
  </script>
</body>
</html>
